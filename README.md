# 自动校准系统模型说明

## 一、概述

参数自动率定模型通过对水文模型参数进行自动化的调优，提升模型的准确性和效率。

本说明涵盖模型的整体结构、各模块的内容及其具体作用，并包含一些代码实现上的重要部分以及应用时的具体注意事项等。

### 版本号

V1.20241111

### 负责人

haoran_zhao

### 发布日期

2024.11.11


### 拉取

| 依赖        | 说明                                     |
|-------------|------------------------------------------|
| V1.20241111 | 支持新安江模型，马斯金根参数自动参数率定   |

## 二、模型结构概览

### 主要文件/文件夹说明

| 文件/文件夹          | 说明                                          |
|---------------------|-----------------------------------------------|
| `main.py`           | 启动主程序，控制各模块的运行。                |
| `Autocali.py`       | 主校准脚本，负责启动自动校准流程。            |
| `config.yml`        | 系统的配置文件，包含路径和参数设置。            |
| `algorithm`         | 遗传算法的实现，包括交叉、变异、采样等逻辑。    |
| ├── `callback.py`   | 优化过程中的回调函数。                          |
| ├── `crossover.py`  | 遗传算法中的交叉操作。                          |
| ├── `mutat.py`      | 变异操作。                                      |
| ├── `output.py`     | 输出优化过程中的数据。                          |
| ├── `repair.py`     | 修复不符合约束条件的个体。                      |
| └── `sampling.py`   | 初始化种群时的采样操作。                        |
| `problem`           | 优化问题的定义与并行计算相关逻辑。              |
| ├── `parall.py`     | 并行计算逻辑，用于加速优化过程。                |
| ├── `para.py`       | 参数管理逻辑。                                  |
| └── `problem.py`    | 定义优化问题，包括目标函数和约束条件。            |
| `runner.py`         | 调度器脚本，控制校准过程的执行顺序。            |
| `pre_process_data`  | 数据预处理模块，包括异常处理和预处理逻辑。        |
| ├── `_exception_handling.py` | 处理数据异常的逻辑。                     |
| └── `preprocess.py` | 数据预处理逻辑。                                |
| `data`              | 数据存放目录，包含原始观测数据和后处理结果。      |
| ├── `1.csv`         | 原始流量观测数据。                              |
| ├── `post_proce.csv`| 后处理数据文件。                                |
| └── `Q_MSKG.csv`    | MSKG 模型相关的流量数据。                        |
| `hydro`             | 水文模型相关文件。                              |
| ├── `水文模型镜像`    | 水文模型的镜像文件。                            |
| │   └── `Hydrologic_V1.20241010.sif` | 水文模型的镜像文件。               |
| ├── `params`        | 参数文件夹。                                    |
| ├── `python`        | Python脚本文件夹。                               |
| ├── `results`       | 水文模拟结果文件夹。                            |
| ├── `settings_calc.cas` | 计算设置文件。                             |
| ├── `settings_calc_day.cas` | 日计算设置文件。                      |
| ├── `settings_calc_mix.cas` | 混合计算设置文件。                    |
| └── `shp`           | SHP文件夹。                                     |
| `flood_seg`         | 洪水事件划分与分类模块。                        |
| ├── `classfication.py` | 洪水事件的分类脚本。                        |
| └── `flood_seg.py`  | 洪水事件的划分脚本。                            |
| `report`            | 报告生成模块。                                  |
| └── `result_report.py` | 生成优化结果报告的脚本。                    |
| `report.docx`       | 校准结果的报告文件。                            |
| `report.log`        | 系统运行的日志记录。                            |
| `result`            | 校准结果的可视化输出。                          |
| ├── `section_1_1.png` | 示例断面1的第1场洪水结果图像。               |
| ├── `section_1_2.png` | 示例断面1的第2场洪水结果图像。               |
| └── `section_2_1.png` | 示例断面2的第1场洪水结果图像。               |

### 模型具体文件结构

```
├── main.py                # 启动主程序，各模块的运行
├── Autocali.py            # 主校准脚本，负责启动自动校准流程
├── config.yml             # 系统的配置文件，包含路径和参数设置
├── algorithm               # 遗传算法的实现，包括交叉、变异、采样等逻辑
│   ├── callback.py        # 优化过程中的回调函数
│   ├── crossover.py       # 遗传算法中的交叉操作
│   ├── mutat.py           # 变异操作
│   ├── output.py          # 输出优化过程中的数据
│   ├── repair.py          # 修复不符合约束条件的个体
│   └── sampling.py        # 初始化种群时的采样操作
├── problem                 # 优化问题的定义与并行计算相关逻辑
│   ├── parall.py          # 并行计算逻辑，用于加速优化过程
│   ├── para.py            # 参数管理逻辑
│   └── problem.py         # 定义优化问题，包括目标函数和约束条件
├── runner.py               # 调度器脚本，控制校准过程的执行顺序
├── pre_process_data        # 数据预处理模块，包括异常处理和预处理逻辑
│   ├── _exception_handling.py  # 处理数据异常的逻辑
│   └── preprocess.py            # 数据预处理逻辑
├── data                    # 数据存放目录，包含原始观测数据和后处理结果
│   ├── 1.csv               # 原始流量观测数据
│   ├── post_proce.csv      # 后处理数据文件
│   └── Q_MSKG.csv          # MSKG 模型相关的流量数据
├── hydro                   # 水文模型相关文件
│   ├── 水文模型镜像
│   │   └── Hydrologic_V1.20241010.sif  # 水文模型的镜像文件
│   ├── params              # 参数文件夹
│   ├── python              # Python脚本文件夹
│   ├── results             # 水文模拟结果文件夹
│   ├── settings_calc.cas   # 计算设置文件
│   ├── settings_calc_day.cas
│   ├── settings_calc_mix.cas
│   └── shp                 # SHP文件夹
├── flood_seg               # 洪水事件划分与分类模块
│   ├── classfication.py    # 洪水事件的分类脚本
│   └── flood_seg.py        # 洪水事件的划分脚本
├── report                  # 报告生成模块
│   └── result_report.py    # 生成优化结果报告的脚本
├── report.docx             # 校准结果的报告文件
├── report.log              # 系统运行的日志记录
├── result                  # 校准结果的可视化输出
│   ├── section_1_1.png     # 示例断面1的第1场洪水结果图像
│   ├── section_1_2.png     # 示例断面1的第2场洪水结果图像
│   └── section_2_1.png     # 示例断面2的第1场洪水结果图像
```

## 三、模型模块细节

### 1. 数据预处理模块

该模块的主要功能可以概括为三个方面：

#### 数据读取

模块从配置文件中获取流量数据路径（`flow_file_paths`），加载原始的流量数据。

#### 异常值检测与修复

由于水文数据的观测过程中不可避免地会存在缺失值和异常值，该模块对数据进行了详细的清洗与修复，包括以下几个步骤：

- **缺失值处理**：数据中的缺失值（`None`）被替换为 NumPy 的 `NaN` 标识符。
- **初步过滤和插值**：将数据中为 `0` 的元素也视为潜在的缺失值，替换为 `NaN`，并进行线性插值。
- **滑动窗口异常检测**：模块使用滑动窗口方法来检测异常值。通过设置一个大小为 `3` 的滑动窗口，模块可以逐步检查流量数据中的各个值是否存在异常。具体来说，在每个窗口中，模块计算当前窗口内的均值，并与窗口中的各个值进行对比。如果发现某个值相对于其他值的偏差大于或小于 `40%`，则将其标记为异常值。进一步的判断会结合一个较小的子窗口均值，以确定这个异常值是否需要被修正。
- **插值修复**：模块多次采用线性插值方法来修复缺失数据和异常值。
- **两端数据处理**：在数据清洗的最后阶段，对数据两端的缺失值进行特别处理，将其替换为 `0`，以确保最终数据集完整无缺失。

### 2. 洪水事件划分与聚类模块

该模块负责将历史数据划分为独立的洪水事件，并通过聚类分析对事件进行分类。主要流程包括：

- **事件划分**：基于设定的时间阈值，将流量数据划分为独立的洪水事件，从而明确每次洪水的开始和结束时间。
- **事件聚类**：在洪水事件划分之后，采用聚类分析对不同的洪水类型进行分类。聚类的目的是识别和归类出具有相似特征的洪水事件，通过设定聚类特征，获得不同大小的洪水场次。

#### 代码实现：

```python
class RunoffClassifier:
    # 聚类特征：最大降雨、最大流量

class FloodSegmentation:
    # FloodSegmentation 类用于处理洪水分割数据。
```

模块通过 `FloodSegmentation` 和 `RunoffClassifier` 类，结合输入配置和目标流域，对历史数据进行划分和聚类。

具体理论部分参考：[洪水场次划分算法 - 格物产品部 - 远算Wiki](#) <!-- 请在此处添加实际链接 -->

### 3. 优化算法模块

优化算法模块采用遗传算法对水文模型的参数进行优化。优化的目标是通过反复调整模型参数，使得模型的输出结果尽可能地符合历史观测数据。

#### 遗传算法的使用

通过设置种群大小、遗传代数等参数，算法会生成不同的参数组合并逐代优化，找到使模型误差最小化的最佳参数。

#### 算法流程

1. **初始化参数的候选解集合**。
2. **进行多代的交叉、变异和选择操作**。
3. **每一代会根据适应度函数计算个体的优劣**。
4. **通过修复和改进策略确保参数在合理范围内**。
5. **经过若干代演化后选择最优的参数集**。

#### 目标函数 (Objective Function)

最大化多个场次 `R²` 平均值。

#### 约束条件 (Constraints)

1. **约束 g1**

   `Ki + Kg <= 0.7`

2. **约束 g2**

   `Q >= 0`

### 4. 校准运行管理

校准运行管理负责调度整个校准过程，包括启动数据预处理、洪水事件划分与聚类，以及控制优化算法的执行。该模块将各步骤有序串联，并确保所有数据和参数的流转无缝衔接。

#### 运行模式

系统支持两种运行模式：

- **模式 A**：仅优化新安江模型中的 15 个参数。
- **模式 B**：在模式 A 的基础上，进一步优化 MSKG 的 2 个参数。

#### 迭代优化过程监控表

示例输出：

```
=================================================================
n_gen  |  n_eval  | train_max | train_mean | train_std | flood_volume_dif | time_dif | max_flood_dif
=================================================================
     1 |        4 |  0.986558 |  0.168165 |  0.685486 |  0.9189 |  0.5000 |  0.8634
     2 |        8 |  0.986558 |  0.864354 |  0.105955 |  0.7228 |  0.5000 |  0.6454
     3 |       12 |  0.986558 |  0.969398 |  0.023984 |  0.8938 |   0E+00 |  0.9579
```

#### 列说明

| 列名               | 含义                      | 解释                                                                                                                                                                  |
|--------------------|---------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `n_gen`            | Generation Number        | 迭代的代数或世代数。在进化算法中，`n_gen` 表示当前所处的代数。每一代代表一次完整的种群进化过程，包括选择、交叉和变异等操作。                                                       |
| `n_eval`           | Number of Evaluations    | 评估次数。表示在当前代数中模型被评估的总次数。                                                                                                                      |
| `train_max`        | Training Maximum         | 训练过程中 `R²` 的最大值。指训练过程中目标函数 `R²` 的最大值。                                                                                                     |
| `train_mean`       | Training Mean            | 训练过程中 `R²` 的平均值。表示当前代数中 `R²` 的平均值，提供整体性能的概览。                                                                                        |
| `train_std`        | Training Standard Deviation | 训练过程中 `R²` 的标准差。衡量训练指标的离散程度或稳定性。标准差越小，表示越稳定。                                                                                 |
| `flood_volume_dif` | Flood Volume Difference  | 洪量差异。单场次洪水总量差异的百分比。该值越高说明洪量越接近。                                                                                                      |
| `time_dif`         | Time Difference          | 洪峰时间差异。表示模型模拟结果与观测数据在时间维度上的误差，即洪水峰值时间的偏差。                                                                                   |
| `max_flood_dif`    | Maximum Flood Difference  | 洪峰差异。记录模型洪峰与实际观测值之间的误差百分比。该值越高说明洪峰越接近。                                                                                         |

### 5. 报告生成模块

报告生成模块用于将校准过程中的关键结果、参数变化过程以及最终的校准效果输出到报告中。报告格式为 Word 文档，便于用户后续查看和分析。生成的报告内容包括：

- **优化过程**：每一代的优化历史，包含当前代的最优参数、种群的整体表现及适应度（`report.log`）。
- **最终结果**：系统给出最优参数配置，并记录整个校准过程的耗时（`report.log`）。
- **图形与可视化**：包括模型拟合度的可视化图表，帮助用户更直观地了解模型的表现（`report.docx`）。

## 四、配置文件 (`config.yml`) 参数详解

`config.yml` 文件是自动校准系统的配置入口。以下是配置文件中所有参数的具体说明：

| 参数名称        | 类型  | 说明                                                                                                                                                      |
|-----------------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| `flow_file_paths` | str   | 指定实际流量数据的路径。此文件包含历史观测的流量时间序列，格式必须是 CSV 或其他支持的数据格式，且每列代表不同的流域。                                     |
| `rain_file_paths` | str   | 降雨数据的路径，用于与流量数据结合进行模型优化。此数据用于模拟降雨对流量的影响。                                                                         |
| `path_out`      | str   | 数据预处理后的输出路径，通常为 CSV 格式。用户可以通过此路径查看经清洗与格式化后的数据。                                                                  |
| `theta`         | int   | 洪水事件划分的时间阈值。该参数控制划分事件时使用的时间窗口，单位为小时，用于确定连续流量何时视为一次洪水事件的开始和结束。                                 |
| `n_clusters`    | int   | 聚类分析的组数，用于将洪水事件分类为不同类型。用户可以调整此参数来增加或减少聚类的数量，从而影响事件特征的精细程度。                                     |
| `cas_path`      | str   | CAS 文件的路径，该文件包含模型运行时所需的设置，例如流域参数的定义。                                                                                    |
| `pre_path`      | str   | 模型预测结果的存储目录。模型每次优化后的结果都会保存到此路径下，便于对比分析。                                                                          |
| `para_path`     | str   | 存储优化过程中使用的参数文件的路径。                                                                                                                    |
| `ini_candidate` | str   | 是否使用初始解，取值为 'Y' 或 'N'。设置为 'Y' 时，系统会从参数文件中读取参数。                                                                         |
| `mode`          | str   | 系统运行模式。'A' 表示优化新安江模型的 15 个参数，'B' 表示优化 15 个新安江参数和 2 个 MSKG 参数。                                                           |
| `column_num`    | list  | 表示流域中需要率定的列号，用于在优化过程中指定具体的流域数据。                                                                                           |
| `core`          | int   | 计算核心数，用于并行化优化。根据机器的性能调整这个参数来提高计算效率。                                                                                   |
| `mskg_columns`  | list  | 模式 B 中 MSKG 的预测数据列，用于选择需要分析的特定流域列。                                                                                             |
| `precision`     | float | 表示参数优化的精度。                                                                                                                                      |
| `n_gen`         | int   | 表示遗传算法的最大迭代次数。                                                                                                                            |
| `pop_size`      | int   | 遗传算法的种群大小。种群越大，搜索的范围越广。                                                                                                          |

## 五、调用配置方法

在进行水文模型计算之前，需要对项目进行适当的配置。水文模型的根目录为 `hydro`，我们需要在 `hydro` 目录下的 `python` 文件夹中配置 `calc.py` 脚本。首先，导入必要的包并设置工作目录及系统路径，以确保脚本能够正确引用项目中的模块。以下是导入包的部分代码示例：

```python
import os
import sys
import time

current_dir = os.getcwd()
os.chdir('./hydro')
sys.path.append(f"{os.getcwd()}/python")

from runoff_forecast.HydroCase import HydroCase
from runoff_forecast.print_colors import *
from reservoir import *

os.chdir(current_dir)
```

为了提高代码的可维护性和可复用性，将所有配置和运行逻辑统一封装到一个名为 `xaj()` 的方法中。将代码封装到 `xaj()` 方法中的示例：

```python
def xaj():
    os.chdir('./hydro')
    sys.path.append(f"{os.getcwd()}/python")
    Routings_func = {
        "XQ": XQ_Routing,
        "BTW": BTW_Routing,
    }
    s = time.time()
    HCalc = HydroCase("settings_calc.cas", log=True)
    HCalc.Resv_routing = Routings_func
    # 读取输入的降雨json文件
    HCalc.Read_raindata_by_json()
    # 生成输入给水文模型的子流域降雨量和蒸发量文件
    HCalc.Generate_PRCP_TS()
    HCalc.Generate_EVAP_TS()
    HCalc.Calc(savePRCP="./input_raindata.csv", debug=False)
    e = time.time()
    print("%.2f s" % (e - s))
    os.chdir(current_dir)
```

